SELECT 
    ROW_NUMBER() OVER (ORDER BY inv.id ASC) AS no, 
    inv.id, 
    inv.item, 
    inv.price,
    GREATEST(inv.stock - COALESCE(sewa.total_sku, 0), 0) AS stock, -- Sinkronisasi stok
    inv.sku,
    inv.merk
FROM (
    SELECT 
        wp_posts.ID AS id, 
        wp_posts.post_title AS item, 
        wp_postmeta_price.meta_value AS price,
        CAST(wp_postmeta_stock.meta_value AS SIGNED) AS stock,
        CONVERT(wp_postmeta_sku.meta_value USING utf8mb4) AS sku, -- Konversi collation
        MAX(wp_terms.name) AS merk
    FROM 
        wp_posts
    LEFT JOIN 
        wp_postmeta AS wp_postmeta_price 
        ON wp_posts.ID = wp_postmeta_price.post_id AND wp_postmeta_price.meta_key = '_price'
    LEFT JOIN 
        wp_postmeta AS wp_postmeta_stock 
        ON wp_posts.ID = wp_postmeta_stock.post_id AND wp_postmeta_stock.meta_key = '_stock'
    LEFT JOIN 
        wp_postmeta AS wp_postmeta_sku 
        ON wp_posts.ID = wp_postmeta_sku.post_id AND wp_postmeta_sku.meta_key = '_sku'
    INNER JOIN  
        wp_term_relationships ON wp_posts.ID = wp_term_relationships.object_id
    INNER JOIN  
        wp_term_taxonomy ON wp_term_relationships.term_taxonomy_id = wp_term_taxonomy.term_taxonomy_id 
        AND wp_term_taxonomy.taxonomy = 'product_brand'
    INNER JOIN  
        wp_terms ON wp_term_taxonomy.term_id = wp_terms.term_id
    WHERE 
        wp_posts.post_type IN ('product', 'product_variation')
        AND wp_postmeta_sku.meta_value != ''
    GROUP BY 
        wp_posts.ID, wp_posts.post_title, wp_postmeta_price.meta_value,
        wp_postmeta_stock.meta_value, wp_postmeta_sku.meta_value
) AS inv
LEFT JOIN (
    SELECT 
        CONVERT(rent_sku USING utf8mb4) AS sku, -- Konversi collation
        COUNT(*) AS total_sku 
    FROM 
        wp_postrent_log 
    GROUP BY rent_sku
) AS sewa ON inv.sku = sewa.sku
ORDER BY inv.id ASC;
